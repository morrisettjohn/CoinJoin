"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.Serialization = exports.Serializable = exports.SERIALIZATIONVERSION = void 0;
/**
 * @packageDocumentation
 * @module Utils-Serialization
 */
const bintools_1 = __importDefault(require("../utils/bintools"));
const bn_js_1 = __importDefault(require("bn.js"));
const buffer_1 = require("buffer/");
const helperfunctions_1 = require("./helperfunctions");
const errors_1 = require("../utils/errors");
exports.SERIALIZATIONVERSION = 0;
class Serializable {
    constructor() {
        this._typeName = undefined;
        this._typeID = undefined;
        this._codecID = undefined;
    }
    /**
     * Used in serialization. TypeName is a string name for the type of object being output.
     */
    getTypeName() {
        return this._typeName;
    }
    /**
     * Used in serialization. Optional. TypeID is a number for the typeID of object being output.
     */
    getTypeID() {
        return this._typeID;
    }
    /**
     * Used in serialization. Optional. TypeID is a number for the typeID of object being output.
     */
    getCodecID() {
        return this._codecID;
    }
    //sometimes the parent class manages the fields
    //these are so you can say super.serialize(encoding); 
    serialize(encoding) {
        return {
            "_typeName": this._typeName,
            "_typeID": (typeof this._typeID === "undefined" ? null : this._typeID),
            "_codecID": (typeof this._codecID === "undefined" ? null : this._codecID)
        };
    }
    ;
    deserialize(fields, encoding) {
        if (typeof fields["_typeName"] !== "string") {
            throw new errors_1.TypeNameError("Error - Serializable.deserialize: _typeName must be a string, found: " + typeof fields["_typeName"]);
        }
        if (fields["_typeName"] !== this._typeName) {
            throw new errors_1.TypeNameError("Error - Serializable.deserialize: _typeName mismatch -- expected: " + this._typeName + " -- recieved: " + fields["_typeName"]);
        }
        if (typeof fields["_typeID"] !== "undefined" && fields["_typeID"] !== null) {
            if (typeof fields["_typeID"] !== "number") {
                throw new errors_1.TypeIdError("Error - Serializable.deserialize: _typeID must be a number, found: " + typeof fields["_typeID"]);
            }
            if (fields["_typeID"] !== this._typeID) {
                throw new errors_1.TypeIdError("Error - Serializable.deserialize: _typeID mismatch -- expected: " + this._typeID + " -- recieved: " + fields["_typeID"]);
            }
        }
        if (typeof fields["_codecID"] !== "undefined" && fields["_codecID"] !== null) {
            if (typeof fields["_codecID"] !== "number") {
                throw new errors_1.CodecIdError("Error - Serializable.deserialize: _codecID must be a number, found: " + typeof fields["_codecID"]);
            }
            if (fields["_codecID"] !== this._codecID) {
                throw new errors_1.CodecIdError("Error - Serializable.deserialize: _codecID mismatch -- expected: " + this._codecID + " -- recieved: " + fields["_codecID"]);
            }
        }
    }
    ;
}
exports.Serializable = Serializable;
class Serialization {
    constructor() {
        this.bintools = bintools_1.default.getInstance();
    }
    /**
     * Retrieves the Serialization singleton.
     */
    static getInstance() {
        if (!Serialization.instance) {
            Serialization.instance = new Serialization();
        }
        return Serialization.instance;
    }
    bufferToType(vb, type, ...args) {
        if (type === "BN") {
            return new bn_js_1.default(vb.toString("hex"), "hex");
        }
        else if (type === "Buffer") {
            if (args.length == 1 && typeof args[0] === "number") {
                vb = buffer_1.Buffer.from(vb.toString("hex").padStart(args[0] * 2, '0'), "hex");
            }
            return vb;
        }
        else if (type === "bech32") {
            return this.bintools.addressToString(args[0], args[1], vb);
        }
        else if (type === "nodeID") {
            return helperfunctions_1.bufferToNodeIDString(vb);
        }
        else if (type === "privateKey") {
            return helperfunctions_1.bufferToPrivateKeyString(vb);
        }
        else if (type === "cb58") {
            return this.bintools.cb58Encode(vb);
        }
        else if (type === "base58") {
            return this.bintools.bufferToB58(vb);
        }
        else if (type === "base64") {
            return vb.toString("base64");
        }
        else if (type === "hex") {
            return vb.toString("hex");
        }
        else if (type === "decimalString") {
            return new bn_js_1.default(vb.toString("hex"), "hex").toString(10);
        }
        else if (type === "number") {
            return new bn_js_1.default(vb.toString("hex"), "hex").toNumber();
        }
        else if (type === "utf8") {
            return vb.toString("utf8");
        }
        return undefined;
    }
    typeToBuffer(v, type, ...args) {
        if (type === "BN") {
            let str = v.toString("hex");
            if (args.length == 1 && typeof args[0] === "number") {
                return buffer_1.Buffer.from(str.padStart(args[0] * 2, '0'), 'hex');
            }
            return buffer_1.Buffer.from(str, 'hex');
        }
        else if (type === "Buffer") {
            return v;
        }
        else if (type === "bech32") {
            return this.bintools.stringToAddress(v);
        }
        else if (type === "nodeID") {
            return helperfunctions_1.NodeIDStringToBuffer(v);
        }
        else if (type === "privateKey") {
            return helperfunctions_1.privateKeyStringToBuffer(v);
        }
        else if (type === "cb58") {
            return this.bintools.cb58Decode(v);
        }
        else if (type === "base58") {
            return this.bintools.b58ToBuffer(v);
        }
        else if (type === "base64") {
            return buffer_1.Buffer.from(v, "base64");
        }
        else if (type === "hex") {
            if (v.startsWith("0x")) {
                v = v.slice(2);
            }
            return buffer_1.Buffer.from(v, "hex");
        }
        else if (type === "decimalString") {
            let str = new bn_js_1.default(v, 10).toString("hex");
            if (args.length == 1 && typeof args[0] === "number") {
                return buffer_1.Buffer.from(str.padStart(args[0] * 2, '0'), 'hex');
            }
            return buffer_1.Buffer.from(str, 'hex');
        }
        else if (type === "number") {
            let str = new bn_js_1.default(v, 10).toString("hex");
            if (args.length == 1 && typeof args[0] === "number") {
                return buffer_1.Buffer.from(str.padStart(args[0] * 2, '0'), 'hex');
            }
            return buffer_1.Buffer.from(str, 'hex');
        }
        else if (type === "utf8") {
            if (args.length == 1 && typeof args[0] === "number") {
                let b = buffer_1.Buffer.alloc(args[0]);
                b.write(v);
                return b;
            }
            return buffer_1.Buffer.from(v, 'utf8');
        }
        return undefined;
    }
    encoder(value, encoding, intype, outtype, ...args) {
        if (typeof value === "undefined") {
            throw new errors_1.UnknownTypeError("Error - Serializable.encoder: value passed is undefined");
        }
        if (encoding !== "display") {
            outtype = encoding;
        }
        let vb = this.typeToBuffer(value, intype, ...args);
        return this.bufferToType(vb, outtype, ...args);
    }
    decoder(value, encoding, intype, outtype, ...args) {
        if (typeof value === "undefined") {
            throw new errors_1.UnknownTypeError("Error - Serializable.decoder: value passed is undefined");
        }
        if (encoding !== "display") {
            intype = encoding;
        }
        let vb = this.typeToBuffer(value, intype, ...args);
        return this.bufferToType(vb, outtype, ...args);
    }
    serialize(serialize, vm, encoding = "display", notes = undefined) {
        if (typeof notes === "undefined") {
            notes = serialize.getTypeName();
        }
        return {
            vm,
            encoding,
            version: exports.SERIALIZATIONVERSION,
            notes,
            fields: serialize.serialize(encoding)
        };
    }
    deserialize(input, output) {
        output.deserialize(input["fields"], input["encoding"]);
    }
}
exports.Serialization = Serialization;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2VyaWFsaXphdGlvbi5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy91dGlscy9zZXJpYWxpemF0aW9uLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7OztBQUFBOzs7R0FHRztBQUNILGlFQUF5QztBQUN6QyxrREFBdUI7QUFDdkIsb0NBQWlDO0FBQ2pDLHVEQUFtSTtBQUNuSSw0Q0FBNkY7QUFFaEYsUUFBQSxvQkFBb0IsR0FBRyxDQUFDLENBQUM7QUE0QnRDLE1BQXNCLFlBQVk7SUFBbEM7UUFDYyxjQUFTLEdBQVUsU0FBUyxDQUFDO1FBQzdCLFlBQU8sR0FBVSxTQUFTLENBQUM7UUFDM0IsYUFBUSxHQUFXLFNBQVMsQ0FBQztJQXdEM0MsQ0FBQztJQXRERzs7T0FFRztJQUNILFdBQVc7UUFDUCxPQUFPLElBQUksQ0FBQyxTQUFTLENBQUM7SUFDMUIsQ0FBQztJQUVEOztPQUVHO0lBQ0gsU0FBUztRQUNMLE9BQU8sSUFBSSxDQUFDLE9BQU8sQ0FBQTtJQUN2QixDQUFDO0lBRUQ7O09BRUc7SUFDSCxVQUFVO1FBQ1IsT0FBTyxJQUFJLENBQUMsUUFBUSxDQUFBO0lBQ3RCLENBQUM7SUFFRCwrQ0FBK0M7SUFDL0Msc0RBQXNEO0lBQ3RELFNBQVMsQ0FBQyxRQUE0QjtRQUNsQyxPQUFPO1lBQ0gsV0FBVyxFQUFFLElBQUksQ0FBQyxTQUFTO1lBQzNCLFNBQVMsRUFBRSxDQUFDLE9BQU8sSUFBSSxDQUFDLE9BQU8sS0FBSyxXQUFXLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQztZQUN0RSxVQUFVLEVBQUUsQ0FBQyxPQUFPLElBQUksQ0FBQyxRQUFRLEtBQUssV0FBVyxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUM7U0FDNUUsQ0FBQTtJQUNMLENBQUM7SUFBQSxDQUFDO0lBQ0YsV0FBVyxDQUFDLE1BQWEsRUFBRSxRQUE0QjtRQUNuRCxJQUFHLE9BQU8sTUFBTSxDQUFDLFdBQVcsQ0FBQyxLQUFLLFFBQVEsRUFBRTtZQUN4QyxNQUFNLElBQUksc0JBQWEsQ0FBQyx1RUFBdUUsR0FBRyxPQUFPLE1BQU0sQ0FBQyxXQUFXLENBQUMsQ0FBQyxDQUFDO1NBQ2pJO1FBQ0QsSUFBRyxNQUFNLENBQUMsV0FBVyxDQUFDLEtBQUssSUFBSSxDQUFDLFNBQVMsRUFBRTtZQUN2QyxNQUFNLElBQUksc0JBQWEsQ0FBQyxvRUFBb0UsR0FBRyxJQUFJLENBQUMsU0FBUyxHQUFHLGdCQUFnQixHQUFHLE1BQU0sQ0FBQyxXQUFXLENBQUMsQ0FBQyxDQUFDO1NBQzNKO1FBQ0QsSUFBRyxPQUFPLE1BQU0sQ0FBQyxTQUFTLENBQUMsS0FBSyxXQUFXLElBQUksTUFBTSxDQUFDLFNBQVMsQ0FBQyxLQUFLLElBQUksRUFBRTtZQUN2RSxJQUFHLE9BQU8sTUFBTSxDQUFDLFNBQVMsQ0FBQyxLQUFLLFFBQVEsRUFBRTtnQkFDdEMsTUFBTSxJQUFJLG9CQUFXLENBQUMscUVBQXFFLEdBQUcsT0FBTyxNQUFNLENBQUMsU0FBUyxDQUFDLENBQUMsQ0FBQzthQUMzSDtZQUNELElBQUcsTUFBTSxDQUFDLFNBQVMsQ0FBQyxLQUFLLElBQUksQ0FBQyxPQUFPLEVBQUU7Z0JBQ25DLE1BQU0sSUFBSSxvQkFBVyxDQUFDLGtFQUFrRSxHQUFHLElBQUksQ0FBQyxPQUFPLEdBQUcsZ0JBQWdCLEdBQUcsTUFBTSxDQUFDLFNBQVMsQ0FBQyxDQUFDLENBQUM7YUFDbko7U0FDSjtRQUNELElBQUcsT0FBTyxNQUFNLENBQUMsVUFBVSxDQUFDLEtBQUssV0FBVyxJQUFJLE1BQU0sQ0FBQyxVQUFVLENBQUMsS0FBSyxJQUFJLEVBQUU7WUFDekUsSUFBRyxPQUFPLE1BQU0sQ0FBQyxVQUFVLENBQUMsS0FBSyxRQUFRLEVBQUU7Z0JBQ3ZDLE1BQU0sSUFBSSxxQkFBWSxDQUFDLHNFQUFzRSxHQUFHLE9BQU8sTUFBTSxDQUFDLFVBQVUsQ0FBQyxDQUFDLENBQUM7YUFDOUg7WUFDRCxJQUFHLE1BQU0sQ0FBQyxVQUFVLENBQUMsS0FBSyxJQUFJLENBQUMsUUFBUSxFQUFFO2dCQUNyQyxNQUFNLElBQUkscUJBQVksQ0FBQyxtRUFBbUUsR0FBRyxJQUFJLENBQUMsUUFBUSxHQUFHLGdCQUFnQixHQUFHLE1BQU0sQ0FBQyxVQUFVLENBQUMsQ0FBQyxDQUFDO2FBQ3ZKO1NBQ0o7SUFDTCxDQUFDO0lBQUEsQ0FBQztDQUNMO0FBM0RELG9DQTJEQztBQUVELE1BQWEsYUFBYTtJQUd0QjtRQUNFLElBQUksQ0FBQyxRQUFRLEdBQUcsa0JBQVEsQ0FBQyxXQUFXLEVBQUUsQ0FBQztJQUN6QyxDQUFDO0lBR0Q7O09BRUc7SUFDSCxNQUFNLENBQUMsV0FBVztRQUNkLElBQUksQ0FBQyxhQUFhLENBQUMsUUFBUSxFQUFFO1lBQ3pCLGFBQWEsQ0FBQyxRQUFRLEdBQUcsSUFBSSxhQUFhLEVBQUUsQ0FBQztTQUNoRDtRQUNELE9BQU8sYUFBYSxDQUFDLFFBQVEsQ0FBQztJQUNsQyxDQUFDO0lBRUQsWUFBWSxDQUFDLEVBQVMsRUFBRSxJQUFtQixFQUFFLEdBQUcsSUFBZTtRQUMzRCxJQUFHLElBQUksS0FBSyxJQUFJLEVBQUU7WUFDZCxPQUFPLElBQUksZUFBRSxDQUFDLEVBQUUsQ0FBQyxRQUFRLENBQUMsS0FBSyxDQUFDLEVBQUUsS0FBSyxDQUFDLENBQUM7U0FDNUM7YUFBTSxJQUFHLElBQUksS0FBSyxRQUFRLEVBQUU7WUFDekIsSUFBRyxJQUFJLENBQUMsTUFBTSxJQUFJLENBQUMsSUFBSSxPQUFPLElBQUksQ0FBQyxDQUFDLENBQUMsS0FBSyxRQUFRLEVBQUM7Z0JBQy9DLEVBQUUsR0FBRyxlQUFNLENBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxRQUFRLENBQUMsS0FBSyxDQUFDLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsR0FBRyxDQUFDLEVBQUUsR0FBRyxDQUFDLEVBQUUsS0FBSyxDQUFDLENBQUE7YUFDekU7WUFDRCxPQUFPLEVBQUUsQ0FBQztTQUNiO2FBQU0sSUFBRyxJQUFJLEtBQUssUUFBUSxFQUFFO1lBQ3pCLE9BQU8sSUFBSSxDQUFDLFFBQVEsQ0FBQyxlQUFlLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxFQUFFLElBQUksQ0FBQyxDQUFDLENBQUMsRUFBRSxFQUFFLENBQUMsQ0FBQztTQUM5RDthQUFNLElBQUcsSUFBSSxLQUFLLFFBQVEsRUFBRTtZQUN6QixPQUFPLHNDQUFvQixDQUFDLEVBQUUsQ0FBQyxDQUFDO1NBQ25DO2FBQU0sSUFBRyxJQUFJLEtBQUssWUFBWSxFQUFFO1lBQzdCLE9BQU8sMENBQXdCLENBQUMsRUFBRSxDQUFDLENBQUM7U0FDdkM7YUFBTSxJQUFHLElBQUksS0FBSyxNQUFNLEVBQUU7WUFDdkIsT0FBTyxJQUFJLENBQUMsUUFBUSxDQUFDLFVBQVUsQ0FBQyxFQUFFLENBQUMsQ0FBQztTQUN2QzthQUFNLElBQUcsSUFBSSxLQUFLLFFBQVEsRUFBRTtZQUN6QixPQUFPLElBQUksQ0FBQyxRQUFRLENBQUMsV0FBVyxDQUFDLEVBQUUsQ0FBQyxDQUFDO1NBQ3hDO2FBQU0sSUFBRyxJQUFJLEtBQUssUUFBUSxFQUFFO1lBQ3pCLE9BQU8sRUFBRSxDQUFDLFFBQVEsQ0FBQyxRQUFRLENBQUMsQ0FBQztTQUNoQzthQUFNLElBQUcsSUFBSSxLQUFLLEtBQUssRUFBRTtZQUN0QixPQUFPLEVBQUUsQ0FBQyxRQUFRLENBQUMsS0FBSyxDQUFDLENBQUM7U0FDN0I7YUFBTSxJQUFHLElBQUksS0FBSyxlQUFlLEVBQUU7WUFDaEMsT0FBTyxJQUFJLGVBQUUsQ0FBQyxFQUFFLENBQUMsUUFBUSxDQUFDLEtBQUssQ0FBQyxFQUFFLEtBQUssQ0FBQyxDQUFDLFFBQVEsQ0FBQyxFQUFFLENBQUMsQ0FBQztTQUN6RDthQUFNLElBQUcsSUFBSSxLQUFLLFFBQVEsRUFBRTtZQUN6QixPQUFPLElBQUksZUFBRSxDQUFDLEVBQUUsQ0FBQyxRQUFRLENBQUMsS0FBSyxDQUFDLEVBQUUsS0FBSyxDQUFDLENBQUMsUUFBUSxFQUFFLENBQUM7U0FDdkQ7YUFBTSxJQUFHLElBQUksS0FBSyxNQUFNLEVBQUU7WUFDdkIsT0FBTyxFQUFFLENBQUMsUUFBUSxDQUFDLE1BQU0sQ0FBQyxDQUFDO1NBQzlCO1FBQ0QsT0FBTyxTQUFTLENBQUM7SUFDckIsQ0FBQztJQUVELFlBQVksQ0FBQyxDQUFLLEVBQUUsSUFBbUIsRUFBRSxHQUFHLElBQWU7UUFDdkQsSUFBRyxJQUFJLEtBQUssSUFBSSxFQUFFO1lBQ2QsSUFBSSxHQUFHLEdBQVcsQ0FBUSxDQUFDLFFBQVEsQ0FBQyxLQUFLLENBQUMsQ0FBQztZQUMzQyxJQUFHLElBQUksQ0FBQyxNQUFNLElBQUksQ0FBQyxJQUFJLE9BQU8sSUFBSSxDQUFDLENBQUMsQ0FBQyxLQUFLLFFBQVEsRUFBQztnQkFDaEQsT0FBTyxlQUFNLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxHQUFHLENBQUMsRUFBRSxHQUFHLENBQUMsRUFBRSxLQUFLLENBQUMsQ0FBQzthQUM1RDtZQUNELE9BQU8sZUFBTSxDQUFDLElBQUksQ0FBQyxHQUFHLEVBQUUsS0FBSyxDQUFDLENBQUM7U0FDbEM7YUFBTSxJQUFHLElBQUksS0FBSyxRQUFRLEVBQUU7WUFDekIsT0FBTyxDQUFDLENBQUM7U0FDWjthQUFNLElBQUcsSUFBSSxLQUFLLFFBQVEsRUFBRTtZQUN6QixPQUFPLElBQUksQ0FBQyxRQUFRLENBQUMsZUFBZSxDQUFDLENBQUMsQ0FBQyxDQUFDO1NBQzNDO2FBQU0sSUFBRyxJQUFJLEtBQUssUUFBUSxFQUFFO1lBQ3pCLE9BQU8sc0NBQW9CLENBQUMsQ0FBQyxDQUFDLENBQUM7U0FDbEM7YUFBTSxJQUFHLElBQUksS0FBSyxZQUFZLEVBQUU7WUFDN0IsT0FBTywwQ0FBd0IsQ0FBQyxDQUFDLENBQUMsQ0FBQztTQUN0QzthQUFNLElBQUcsSUFBSSxLQUFLLE1BQU0sRUFBRTtZQUN2QixPQUFPLElBQUksQ0FBQyxRQUFRLENBQUMsVUFBVSxDQUFDLENBQUMsQ0FBQyxDQUFDO1NBQ3RDO2FBQU0sSUFBRyxJQUFJLEtBQUssUUFBUSxFQUFFO1lBQ3pCLE9BQU8sSUFBSSxDQUFDLFFBQVEsQ0FBQyxXQUFXLENBQUMsQ0FBQyxDQUFDLENBQUM7U0FDdkM7YUFBTSxJQUFHLElBQUksS0FBSyxRQUFRLEVBQUU7WUFDekIsT0FBTyxlQUFNLENBQUMsSUFBSSxDQUFDLENBQVcsRUFBRSxRQUFRLENBQUMsQ0FBQztTQUM3QzthQUFNLElBQUcsSUFBSSxLQUFLLEtBQUssRUFBRTtZQUN0QixJQUFJLENBQVksQ0FBQyxVQUFVLENBQUMsSUFBSSxDQUFDLEVBQUM7Z0JBQzlCLENBQUMsR0FBSSxDQUFZLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDO2FBQzlCO1lBQ0QsT0FBTyxlQUFNLENBQUMsSUFBSSxDQUFDLENBQVcsRUFBRSxLQUFLLENBQUMsQ0FBQztTQUMxQzthQUFNLElBQUcsSUFBSSxLQUFLLGVBQWUsRUFBRTtZQUNoQyxJQUFJLEdBQUcsR0FBVSxJQUFJLGVBQUUsQ0FBQyxDQUFXLEVBQUUsRUFBRSxDQUFDLENBQUMsUUFBUSxDQUFDLEtBQUssQ0FBQyxDQUFDO1lBQ3pELElBQUcsSUFBSSxDQUFDLE1BQU0sSUFBSSxDQUFDLElBQUksT0FBTyxJQUFJLENBQUMsQ0FBQyxDQUFDLEtBQUssUUFBUSxFQUFDO2dCQUMvQyxPQUFPLGVBQU0sQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLFFBQVEsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxFQUFFLEdBQUcsQ0FBQyxFQUFFLEtBQUssQ0FBQyxDQUFDO2FBQzdEO1lBQ0QsT0FBTyxlQUFNLENBQUMsSUFBSSxDQUFDLEdBQUcsRUFBRSxLQUFLLENBQUMsQ0FBQztTQUNsQzthQUFNLElBQUcsSUFBSSxLQUFLLFFBQVEsRUFBRTtZQUN6QixJQUFJLEdBQUcsR0FBVSxJQUFJLGVBQUUsQ0FBQyxDQUFDLEVBQUUsRUFBRSxDQUFDLENBQUMsUUFBUSxDQUFDLEtBQUssQ0FBQyxDQUFDO1lBQy9DLElBQUcsSUFBSSxDQUFDLE1BQU0sSUFBSSxDQUFDLElBQUksT0FBTyxJQUFJLENBQUMsQ0FBQyxDQUFDLEtBQUssUUFBUSxFQUFDO2dCQUMvQyxPQUFPLGVBQU0sQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLFFBQVEsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxFQUFFLEdBQUcsQ0FBQyxFQUFFLEtBQUssQ0FBQyxDQUFDO2FBQzdEO1lBQ0QsT0FBTyxlQUFNLENBQUMsSUFBSSxDQUFDLEdBQUcsRUFBRSxLQUFLLENBQUMsQ0FBQztTQUNsQzthQUFNLElBQUcsSUFBSSxLQUFLLE1BQU0sRUFBRTtZQUN2QixJQUFHLElBQUksQ0FBQyxNQUFNLElBQUksQ0FBQyxJQUFJLE9BQU8sSUFBSSxDQUFDLENBQUMsQ0FBQyxLQUFLLFFBQVEsRUFBQztnQkFDL0MsSUFBSSxDQUFDLEdBQVUsZUFBTSxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztnQkFDckMsQ0FBQyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQTtnQkFDVixPQUFPLENBQUMsQ0FBQzthQUNaO1lBQ0QsT0FBTyxlQUFNLENBQUMsSUFBSSxDQUFDLENBQUMsRUFBRSxNQUFNLENBQUMsQ0FBQztTQUNqQztRQUNELE9BQU8sU0FBUyxDQUFDO0lBQ3JCLENBQUM7SUFFRCxPQUFPLENBQUMsS0FBUyxFQUFFLFFBQTJCLEVBQUUsTUFBcUIsRUFBRSxPQUFzQixFQUFFLEdBQUcsSUFBZTtRQUM3RyxJQUFHLE9BQU8sS0FBSyxLQUFLLFdBQVcsRUFBQztZQUM1QixNQUFNLElBQUkseUJBQWdCLENBQUMseURBQXlELENBQUMsQ0FBQztTQUN6RjtRQUNELElBQUcsUUFBUSxLQUFLLFNBQVMsRUFBQztZQUN0QixPQUFPLEdBQUcsUUFBUSxDQUFDO1NBQ3RCO1FBQ0QsSUFBSSxFQUFFLEdBQVUsSUFBSSxDQUFDLFlBQVksQ0FBQyxLQUFLLEVBQUUsTUFBTSxFQUFFLEdBQUcsSUFBSSxDQUFDLENBQUM7UUFDMUQsT0FBTyxJQUFJLENBQUMsWUFBWSxDQUFDLEVBQUUsRUFBRSxPQUFPLEVBQUUsR0FBRyxJQUFJLENBQUMsQ0FBQztJQUNuRCxDQUFDO0lBR0QsT0FBTyxDQUFDLEtBQVksRUFBRSxRQUEyQixFQUFFLE1BQXFCLEVBQUUsT0FBc0IsRUFBRSxHQUFHLElBQWU7UUFDaEgsSUFBRyxPQUFPLEtBQUssS0FBSyxXQUFXLEVBQUM7WUFDNUIsTUFBTSxJQUFJLHlCQUFnQixDQUFDLHlEQUF5RCxDQUFDLENBQUM7U0FDekY7UUFDRCxJQUFHLFFBQVEsS0FBSyxTQUFTLEVBQUU7WUFDdkIsTUFBTSxHQUFHLFFBQVEsQ0FBQztTQUNyQjtRQUNELElBQUksRUFBRSxHQUFVLElBQUksQ0FBQyxZQUFZLENBQUMsS0FBSyxFQUFFLE1BQU0sRUFBRSxHQUFHLElBQUksQ0FBQyxDQUFDO1FBQzFELE9BQU8sSUFBSSxDQUFDLFlBQVksQ0FBQyxFQUFFLEVBQUUsT0FBTyxFQUFFLEdBQUcsSUFBSSxDQUFDLENBQUM7SUFDbkQsQ0FBQztJQUVELFNBQVMsQ0FBQyxTQUFzQixFQUFFLEVBQVMsRUFBRSxXQUE4QixTQUFTLEVBQUUsUUFBZSxTQUFTO1FBQzFHLElBQUcsT0FBTyxLQUFLLEtBQUssV0FBVyxFQUFDO1lBQzVCLEtBQUssR0FBRyxTQUFTLENBQUMsV0FBVyxFQUFFLENBQUM7U0FDbkM7UUFDRCxPQUFPO1lBQ0gsRUFBRTtZQUNGLFFBQVE7WUFDUixPQUFPLEVBQUUsNEJBQW9CO1lBQzdCLEtBQUs7WUFDTCxNQUFNLEVBQUUsU0FBUyxDQUFDLFNBQVMsQ0FBQyxRQUFRLENBQUM7U0FDeEMsQ0FBQTtJQUNMLENBQUM7SUFFRCxXQUFXLENBQUMsS0FBWSxFQUFFLE1BQW1CO1FBQ3pDLE1BQU0sQ0FBQyxXQUFXLENBQUMsS0FBSyxDQUFDLFFBQVEsQ0FBQyxFQUFFLEtBQUssQ0FBQyxVQUFVLENBQUMsQ0FBQyxDQUFDO0lBQzNELENBQUM7Q0FDSjtBQTFJRCxzQ0EwSUMiLCJzb3VyY2VzQ29udGVudCI6WyIvKipcbiAqIEBwYWNrYWdlRG9jdW1lbnRhdGlvblxuICogQG1vZHVsZSBVdGlscy1TZXJpYWxpemF0aW9uXG4gKi9cbmltcG9ydCBCaW5Ub29scyBmcm9tICcuLi91dGlscy9iaW50b29scyc7XG5pbXBvcnQgQk4gZnJvbSAnYm4uanMnO1xuaW1wb3J0IHsgQnVmZmVyIH0gZnJvbSAnYnVmZmVyLyc7XG5pbXBvcnQgeyBOb2RlSURTdHJpbmdUb0J1ZmZlciwgcHJpdmF0ZUtleVN0cmluZ1RvQnVmZmVyLCBidWZmZXJUb05vZGVJRFN0cmluZywgYnVmZmVyVG9Qcml2YXRlS2V5U3RyaW5nIH0gZnJvbSAnLi9oZWxwZXJmdW5jdGlvbnMnO1xuaW1wb3J0IHsgQ29kZWNJZEVycm9yLCBUeXBlSWRFcnJvciwgVHlwZU5hbWVFcnJvciwgVW5rbm93blR5cGVFcnJvciB9IGZyb20gJy4uL3V0aWxzL2Vycm9ycyc7XG5cbmV4cG9ydCBjb25zdCBTRVJJQUxJWkFUSU9OVkVSU0lPTiA9IDA7XG5cbmV4cG9ydCB0eXBlIFNlcmlhbGl6ZWRUeXBlID0gXG4gICdoZXgnIFxufCAnQk4nIFxufCAnQnVmZmVyJyBcbnwgJ2JlY2gzMicgXG58ICdub2RlSUQnXG58ICdwcml2YXRlS2V5J1xufCAnY2I1OCcgXG58ICdiYXNlNTgnIFxufCAnYmFzZTY0JyBcbnwgJ2RlY2ltYWxTdHJpbmcnXG58ICdudW1iZXInXG58ICd1dGY4J1xuO1xuXG5leHBvcnQgdHlwZSBTZXJpYWxpemVkRW5jb2RpbmcgPSBcbiAgJ2hleCcgXG58ICdjYjU4JyBcbnwgJ2Jhc2U1OCcgXG58ICdiYXNlNjQnIFxufCAnZGVjaW1hbFN0cmluZydcbnwgJ251bWJlcidcbnwgJ3V0ZjgnXG58ICdkaXNwbGF5J1xuO1xuXG5leHBvcnQgYWJzdHJhY3QgY2xhc3MgU2VyaWFsaXphYmxlIHtcbiAgICBwcm90ZWN0ZWQgX3R5cGVOYW1lOnN0cmluZyA9IHVuZGVmaW5lZDtcbiAgICBwcm90ZWN0ZWQgX3R5cGVJRDpudW1iZXIgPSB1bmRlZmluZWQ7XG4gICAgcHJvdGVjdGVkIF9jb2RlY0lEOiBudW1iZXIgPSB1bmRlZmluZWQ7XG5cbiAgICAvKipcbiAgICAgKiBVc2VkIGluIHNlcmlhbGl6YXRpb24uIFR5cGVOYW1lIGlzIGEgc3RyaW5nIG5hbWUgZm9yIHRoZSB0eXBlIG9mIG9iamVjdCBiZWluZyBvdXRwdXQuXG4gICAgICovXG4gICAgZ2V0VHlwZU5hbWUoKTpzdHJpbmcge1xuICAgICAgICByZXR1cm4gdGhpcy5fdHlwZU5hbWU7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogVXNlZCBpbiBzZXJpYWxpemF0aW9uLiBPcHRpb25hbC4gVHlwZUlEIGlzIGEgbnVtYmVyIGZvciB0aGUgdHlwZUlEIG9mIG9iamVjdCBiZWluZyBvdXRwdXQuXG4gICAgICovXG4gICAgZ2V0VHlwZUlEKCk6bnVtYmVyIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuX3R5cGVJRFxuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFVzZWQgaW4gc2VyaWFsaXphdGlvbi4gT3B0aW9uYWwuIFR5cGVJRCBpcyBhIG51bWJlciBmb3IgdGhlIHR5cGVJRCBvZiBvYmplY3QgYmVpbmcgb3V0cHV0LlxuICAgICAqL1xuICAgIGdldENvZGVjSUQoKTogbnVtYmVyIHtcbiAgICAgIHJldHVybiB0aGlzLl9jb2RlY0lEXG4gICAgfVxuXG4gICAgLy9zb21ldGltZXMgdGhlIHBhcmVudCBjbGFzcyBtYW5hZ2VzIHRoZSBmaWVsZHNcbiAgICAvL3RoZXNlIGFyZSBzbyB5b3UgY2FuIHNheSBzdXBlci5zZXJpYWxpemUoZW5jb2RpbmcpOyBcbiAgICBzZXJpYWxpemUoZW5jb2Rpbmc/OlNlcmlhbGl6ZWRFbmNvZGluZyk6b2JqZWN0IHtcbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgIFwiX3R5cGVOYW1lXCI6IHRoaXMuX3R5cGVOYW1lLFxuICAgICAgICAgICAgXCJfdHlwZUlEXCI6ICh0eXBlb2YgdGhpcy5fdHlwZUlEID09PSBcInVuZGVmaW5lZFwiID8gbnVsbCA6IHRoaXMuX3R5cGVJRCksXG4gICAgICAgICAgICBcIl9jb2RlY0lEXCI6ICh0eXBlb2YgdGhpcy5fY29kZWNJRCA9PT0gXCJ1bmRlZmluZWRcIiA/IG51bGwgOiB0aGlzLl9jb2RlY0lEKVxuICAgICAgICB9XG4gICAgfTsgXG4gICAgZGVzZXJpYWxpemUoZmllbGRzOm9iamVjdCwgZW5jb2Rpbmc/OlNlcmlhbGl6ZWRFbmNvZGluZykge1xuICAgICAgICBpZih0eXBlb2YgZmllbGRzW1wiX3R5cGVOYW1lXCJdICE9PSBcInN0cmluZ1wiKSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgVHlwZU5hbWVFcnJvcihcIkVycm9yIC0gU2VyaWFsaXphYmxlLmRlc2VyaWFsaXplOiBfdHlwZU5hbWUgbXVzdCBiZSBhIHN0cmluZywgZm91bmQ6IFwiICsgdHlwZW9mIGZpZWxkc1tcIl90eXBlTmFtZVwiXSk7XG4gICAgICAgIH1cbiAgICAgICAgaWYoZmllbGRzW1wiX3R5cGVOYW1lXCJdICE9PSB0aGlzLl90eXBlTmFtZSkge1xuICAgICAgICAgICAgdGhyb3cgbmV3IFR5cGVOYW1lRXJyb3IoXCJFcnJvciAtIFNlcmlhbGl6YWJsZS5kZXNlcmlhbGl6ZTogX3R5cGVOYW1lIG1pc21hdGNoIC0tIGV4cGVjdGVkOiBcIiArIHRoaXMuX3R5cGVOYW1lICsgXCIgLS0gcmVjaWV2ZWQ6IFwiICsgZmllbGRzW1wiX3R5cGVOYW1lXCJdKTtcbiAgICAgICAgfVxuICAgICAgICBpZih0eXBlb2YgZmllbGRzW1wiX3R5cGVJRFwiXSAhPT0gXCJ1bmRlZmluZWRcIiAmJiBmaWVsZHNbXCJfdHlwZUlEXCJdICE9PSBudWxsKSB7XG4gICAgICAgICAgICBpZih0eXBlb2YgZmllbGRzW1wiX3R5cGVJRFwiXSAhPT0gXCJudW1iZXJcIikge1xuICAgICAgICAgICAgICAgIHRocm93IG5ldyBUeXBlSWRFcnJvcihcIkVycm9yIC0gU2VyaWFsaXphYmxlLmRlc2VyaWFsaXplOiBfdHlwZUlEIG11c3QgYmUgYSBudW1iZXIsIGZvdW5kOiBcIiArIHR5cGVvZiBmaWVsZHNbXCJfdHlwZUlEXCJdKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGlmKGZpZWxkc1tcIl90eXBlSURcIl0gIT09IHRoaXMuX3R5cGVJRCkge1xuICAgICAgICAgICAgICAgIHRocm93IG5ldyBUeXBlSWRFcnJvcihcIkVycm9yIC0gU2VyaWFsaXphYmxlLmRlc2VyaWFsaXplOiBfdHlwZUlEIG1pc21hdGNoIC0tIGV4cGVjdGVkOiBcIiArIHRoaXMuX3R5cGVJRCArIFwiIC0tIHJlY2lldmVkOiBcIiArIGZpZWxkc1tcIl90eXBlSURcIl0pO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIGlmKHR5cGVvZiBmaWVsZHNbXCJfY29kZWNJRFwiXSAhPT0gXCJ1bmRlZmluZWRcIiAmJiBmaWVsZHNbXCJfY29kZWNJRFwiXSAhPT0gbnVsbCkge1xuICAgICAgICAgICAgaWYodHlwZW9mIGZpZWxkc1tcIl9jb2RlY0lEXCJdICE9PSBcIm51bWJlclwiKSB7XG4gICAgICAgICAgICAgICAgdGhyb3cgbmV3IENvZGVjSWRFcnJvcihcIkVycm9yIC0gU2VyaWFsaXphYmxlLmRlc2VyaWFsaXplOiBfY29kZWNJRCBtdXN0IGJlIGEgbnVtYmVyLCBmb3VuZDogXCIgKyB0eXBlb2YgZmllbGRzW1wiX2NvZGVjSURcIl0pO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYoZmllbGRzW1wiX2NvZGVjSURcIl0gIT09IHRoaXMuX2NvZGVjSUQpIHtcbiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgQ29kZWNJZEVycm9yKFwiRXJyb3IgLSBTZXJpYWxpemFibGUuZGVzZXJpYWxpemU6IF9jb2RlY0lEIG1pc21hdGNoIC0tIGV4cGVjdGVkOiBcIiArIHRoaXMuX2NvZGVjSUQgKyBcIiAtLSByZWNpZXZlZDogXCIgKyBmaWVsZHNbXCJfY29kZWNJRFwiXSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9O1xufVxuXG5leHBvcnQgY2xhc3MgU2VyaWFsaXphdGlvbiB7XG4gICAgcHJpdmF0ZSBzdGF0aWMgaW5zdGFuY2U6U2VyaWFsaXphdGlvbjtcbiAgXG4gICAgcHJpdmF0ZSBjb25zdHJ1Y3RvcigpIHtcbiAgICAgIHRoaXMuYmludG9vbHMgPSBCaW5Ub29scy5nZXRJbnN0YW5jZSgpO1xuICAgIH1cbiAgICBwcml2YXRlIGJpbnRvb2xzOkJpblRvb2xzO1xuXG4gICAgLyoqXG4gICAgICogUmV0cmlldmVzIHRoZSBTZXJpYWxpemF0aW9uIHNpbmdsZXRvbi5cbiAgICAgKi9cbiAgICBzdGF0aWMgZ2V0SW5zdGFuY2UoKTogU2VyaWFsaXphdGlvbiB7XG4gICAgICAgIGlmICghU2VyaWFsaXphdGlvbi5pbnN0YW5jZSkge1xuICAgICAgICAgICAgU2VyaWFsaXphdGlvbi5pbnN0YW5jZSA9IG5ldyBTZXJpYWxpemF0aW9uKCk7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIFNlcmlhbGl6YXRpb24uaW5zdGFuY2U7XG4gICAgfVxuXG4gICAgYnVmZmVyVG9UeXBlKHZiOkJ1ZmZlciwgdHlwZTpTZXJpYWxpemVkVHlwZSwgLi4uYXJnczpBcnJheTxhbnk+KTphbnkge1xuICAgICAgICBpZih0eXBlID09PSBcIkJOXCIpIHtcbiAgICAgICAgICAgIHJldHVybiBuZXcgQk4odmIudG9TdHJpbmcoXCJoZXhcIiksIFwiaGV4XCIpO1xuICAgICAgICB9IGVsc2UgaWYodHlwZSA9PT0gXCJCdWZmZXJcIikge1xuICAgICAgICAgICAgaWYoYXJncy5sZW5ndGggPT0gMSAmJiB0eXBlb2YgYXJnc1swXSA9PT0gXCJudW1iZXJcIil7XG4gICAgICAgICAgICAgICAgdmIgPSBCdWZmZXIuZnJvbSh2Yi50b1N0cmluZyhcImhleFwiKS5wYWRTdGFydChhcmdzWzBdICogMiwgJzAnKSwgXCJoZXhcIilcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHJldHVybiB2YjtcbiAgICAgICAgfSBlbHNlIGlmKHR5cGUgPT09IFwiYmVjaDMyXCIpIHtcbiAgICAgICAgICAgIHJldHVybiB0aGlzLmJpbnRvb2xzLmFkZHJlc3NUb1N0cmluZyhhcmdzWzBdLCBhcmdzWzFdLCB2Yik7XG4gICAgICAgIH0gZWxzZSBpZih0eXBlID09PSBcIm5vZGVJRFwiKSB7XG4gICAgICAgICAgICByZXR1cm4gYnVmZmVyVG9Ob2RlSURTdHJpbmcodmIpO1xuICAgICAgICB9IGVsc2UgaWYodHlwZSA9PT0gXCJwcml2YXRlS2V5XCIpIHtcbiAgICAgICAgICAgIHJldHVybiBidWZmZXJUb1ByaXZhdGVLZXlTdHJpbmcodmIpO1xuICAgICAgICB9IGVsc2UgaWYodHlwZSA9PT0gXCJjYjU4XCIpIHtcbiAgICAgICAgICAgIHJldHVybiB0aGlzLmJpbnRvb2xzLmNiNThFbmNvZGUodmIpO1xuICAgICAgICB9IGVsc2UgaWYodHlwZSA9PT0gXCJiYXNlNThcIikge1xuICAgICAgICAgICAgcmV0dXJuIHRoaXMuYmludG9vbHMuYnVmZmVyVG9CNTgodmIpO1xuICAgICAgICB9IGVsc2UgaWYodHlwZSA9PT0gXCJiYXNlNjRcIikge1xuICAgICAgICAgICAgcmV0dXJuIHZiLnRvU3RyaW5nKFwiYmFzZTY0XCIpO1xuICAgICAgICB9IGVsc2UgaWYodHlwZSA9PT0gXCJoZXhcIikge1xuICAgICAgICAgICAgcmV0dXJuIHZiLnRvU3RyaW5nKFwiaGV4XCIpO1xuICAgICAgICB9IGVsc2UgaWYodHlwZSA9PT0gXCJkZWNpbWFsU3RyaW5nXCIpIHtcbiAgICAgICAgICAgIHJldHVybiBuZXcgQk4odmIudG9TdHJpbmcoXCJoZXhcIiksIFwiaGV4XCIpLnRvU3RyaW5nKDEwKTtcbiAgICAgICAgfSBlbHNlIGlmKHR5cGUgPT09IFwibnVtYmVyXCIpIHtcbiAgICAgICAgICAgIHJldHVybiBuZXcgQk4odmIudG9TdHJpbmcoXCJoZXhcIiksIFwiaGV4XCIpLnRvTnVtYmVyKCk7XG4gICAgICAgIH0gZWxzZSBpZih0eXBlID09PSBcInV0ZjhcIikge1xuICAgICAgICAgICAgcmV0dXJuIHZiLnRvU3RyaW5nKFwidXRmOFwiKTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gdW5kZWZpbmVkO1xuICAgIH1cblxuICAgIHR5cGVUb0J1ZmZlcih2OmFueSwgdHlwZTpTZXJpYWxpemVkVHlwZSwgLi4uYXJnczpBcnJheTxhbnk+KTpCdWZmZXIge1xuICAgICAgICBpZih0eXBlID09PSBcIkJOXCIpIHtcbiAgICAgICAgICAgIGxldCBzdHI6c3RyaW5nID0gKHYgYXMgQk4pLnRvU3RyaW5nKFwiaGV4XCIpO1xuICAgICAgICAgICAgaWYoYXJncy5sZW5ndGggPT0gMSAmJiB0eXBlb2YgYXJnc1swXSA9PT0gXCJudW1iZXJcIil7XG4gICAgICAgICAgICAgICByZXR1cm4gQnVmZmVyLmZyb20oc3RyLnBhZFN0YXJ0KGFyZ3NbMF0gKiAyLCAnMCcpLCAnaGV4Jyk7IFxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgcmV0dXJuIEJ1ZmZlci5mcm9tKHN0ciwgJ2hleCcpOyBcbiAgICAgICAgfSBlbHNlIGlmKHR5cGUgPT09IFwiQnVmZmVyXCIpIHtcbiAgICAgICAgICAgIHJldHVybiB2O1xuICAgICAgICB9IGVsc2UgaWYodHlwZSA9PT0gXCJiZWNoMzJcIikge1xuICAgICAgICAgICAgcmV0dXJuIHRoaXMuYmludG9vbHMuc3RyaW5nVG9BZGRyZXNzKHYpO1xuICAgICAgICB9IGVsc2UgaWYodHlwZSA9PT0gXCJub2RlSURcIikge1xuICAgICAgICAgICAgcmV0dXJuIE5vZGVJRFN0cmluZ1RvQnVmZmVyKHYpO1xuICAgICAgICB9IGVsc2UgaWYodHlwZSA9PT0gXCJwcml2YXRlS2V5XCIpIHtcbiAgICAgICAgICAgIHJldHVybiBwcml2YXRlS2V5U3RyaW5nVG9CdWZmZXIodik7XG4gICAgICAgIH0gZWxzZSBpZih0eXBlID09PSBcImNiNThcIikge1xuICAgICAgICAgICAgcmV0dXJuIHRoaXMuYmludG9vbHMuY2I1OERlY29kZSh2KTtcbiAgICAgICAgfSBlbHNlIGlmKHR5cGUgPT09IFwiYmFzZTU4XCIpIHtcbiAgICAgICAgICAgIHJldHVybiB0aGlzLmJpbnRvb2xzLmI1OFRvQnVmZmVyKHYpO1xuICAgICAgICB9IGVsc2UgaWYodHlwZSA9PT0gXCJiYXNlNjRcIikge1xuICAgICAgICAgICAgcmV0dXJuIEJ1ZmZlci5mcm9tKHYgYXMgc3RyaW5nLCBcImJhc2U2NFwiKTtcbiAgICAgICAgfSBlbHNlIGlmKHR5cGUgPT09IFwiaGV4XCIpIHtcbiAgICAgICAgICAgIGlmKCh2IGFzIHN0cmluZykuc3RhcnRzV2l0aChcIjB4XCIpKXtcbiAgICAgICAgICAgICAgICB2ID0gKHYgYXMgc3RyaW5nKS5zbGljZSgyKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHJldHVybiBCdWZmZXIuZnJvbSh2IGFzIHN0cmluZywgXCJoZXhcIik7XG4gICAgICAgIH0gZWxzZSBpZih0eXBlID09PSBcImRlY2ltYWxTdHJpbmdcIikge1xuICAgICAgICAgICAgbGV0IHN0cjpzdHJpbmcgPSBuZXcgQk4odiBhcyBzdHJpbmcsIDEwKS50b1N0cmluZyhcImhleFwiKTtcbiAgICAgICAgICAgIGlmKGFyZ3MubGVuZ3RoID09IDEgJiYgdHlwZW9mIGFyZ3NbMF0gPT09IFwibnVtYmVyXCIpe1xuICAgICAgICAgICAgICAgIHJldHVybiBCdWZmZXIuZnJvbShzdHIucGFkU3RhcnQoYXJnc1swXSAqIDIsICcwJyksICdoZXgnKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHJldHVybiBCdWZmZXIuZnJvbShzdHIsICdoZXgnKTtcbiAgICAgICAgfSBlbHNlIGlmKHR5cGUgPT09IFwibnVtYmVyXCIpIHtcbiAgICAgICAgICAgIGxldCBzdHI6c3RyaW5nID0gbmV3IEJOKHYsIDEwKS50b1N0cmluZyhcImhleFwiKTtcbiAgICAgICAgICAgIGlmKGFyZ3MubGVuZ3RoID09IDEgJiYgdHlwZW9mIGFyZ3NbMF0gPT09IFwibnVtYmVyXCIpe1xuICAgICAgICAgICAgICAgIHJldHVybiBCdWZmZXIuZnJvbShzdHIucGFkU3RhcnQoYXJnc1swXSAqIDIsICcwJyksICdoZXgnKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHJldHVybiBCdWZmZXIuZnJvbShzdHIsICdoZXgnKTtcbiAgICAgICAgfSBlbHNlIGlmKHR5cGUgPT09IFwidXRmOFwiKSB7XG4gICAgICAgICAgICBpZihhcmdzLmxlbmd0aCA9PSAxICYmIHR5cGVvZiBhcmdzWzBdID09PSBcIm51bWJlclwiKXtcbiAgICAgICAgICAgICAgICBsZXQgYjpCdWZmZXIgPSBCdWZmZXIuYWxsb2MoYXJnc1swXSk7XG4gICAgICAgICAgICAgICAgYi53cml0ZSh2KVxuICAgICAgICAgICAgICAgIHJldHVybiBiO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgcmV0dXJuIEJ1ZmZlci5mcm9tKHYsICd1dGY4Jyk7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIHVuZGVmaW5lZDtcbiAgICB9XG5cbiAgICBlbmNvZGVyKHZhbHVlOmFueSwgZW5jb2Rpbmc6U2VyaWFsaXplZEVuY29kaW5nLCBpbnR5cGU6U2VyaWFsaXplZFR5cGUsIG91dHR5cGU6U2VyaWFsaXplZFR5cGUsIC4uLmFyZ3M6QXJyYXk8YW55Pik6c3RyaW5nIHtcbiAgICAgICAgaWYodHlwZW9mIHZhbHVlID09PSBcInVuZGVmaW5lZFwiKXtcbiAgICAgICAgICAgIHRocm93IG5ldyBVbmtub3duVHlwZUVycm9yKFwiRXJyb3IgLSBTZXJpYWxpemFibGUuZW5jb2RlcjogdmFsdWUgcGFzc2VkIGlzIHVuZGVmaW5lZFwiKTtcbiAgICAgICAgfVxuICAgICAgICBpZihlbmNvZGluZyAhPT0gXCJkaXNwbGF5XCIpe1xuICAgICAgICAgICAgb3V0dHlwZSA9IGVuY29kaW5nO1xuICAgICAgICB9XG4gICAgICAgIGxldCB2YjpCdWZmZXIgPSB0aGlzLnR5cGVUb0J1ZmZlcih2YWx1ZSwgaW50eXBlLCAuLi5hcmdzKTtcbiAgICAgICAgcmV0dXJuIHRoaXMuYnVmZmVyVG9UeXBlKHZiLCBvdXR0eXBlLCAuLi5hcmdzKTtcbiAgICB9XG5cblxuICAgIGRlY29kZXIodmFsdWU6c3RyaW5nLCBlbmNvZGluZzpTZXJpYWxpemVkRW5jb2RpbmcsIGludHlwZTpTZXJpYWxpemVkVHlwZSwgb3V0dHlwZTpTZXJpYWxpemVkVHlwZSwgLi4uYXJnczpBcnJheTxhbnk+KTphbnkge1xuICAgICAgICBpZih0eXBlb2YgdmFsdWUgPT09IFwidW5kZWZpbmVkXCIpe1xuICAgICAgICAgICAgdGhyb3cgbmV3IFVua25vd25UeXBlRXJyb3IoXCJFcnJvciAtIFNlcmlhbGl6YWJsZS5kZWNvZGVyOiB2YWx1ZSBwYXNzZWQgaXMgdW5kZWZpbmVkXCIpO1xuICAgICAgICB9XG4gICAgICAgIGlmKGVuY29kaW5nICE9PSBcImRpc3BsYXlcIikge1xuICAgICAgICAgICAgaW50eXBlID0gZW5jb2Rpbmc7XG4gICAgICAgIH0gXG4gICAgICAgIGxldCB2YjpCdWZmZXIgPSB0aGlzLnR5cGVUb0J1ZmZlcih2YWx1ZSwgaW50eXBlLCAuLi5hcmdzKTtcbiAgICAgICAgcmV0dXJuIHRoaXMuYnVmZmVyVG9UeXBlKHZiLCBvdXR0eXBlLCAuLi5hcmdzKTtcbiAgICB9XG5cbiAgICBzZXJpYWxpemUoc2VyaWFsaXplOlNlcmlhbGl6YWJsZSwgdm06c3RyaW5nLCBlbmNvZGluZzpTZXJpYWxpemVkRW5jb2RpbmcgPSBcImRpc3BsYXlcIiwgbm90ZXM6c3RyaW5nID0gdW5kZWZpbmVkKTpvYmplY3Qge1xuICAgICAgICBpZih0eXBlb2Ygbm90ZXMgPT09IFwidW5kZWZpbmVkXCIpe1xuICAgICAgICAgICAgbm90ZXMgPSBzZXJpYWxpemUuZ2V0VHlwZU5hbWUoKTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgdm0sXG4gICAgICAgICAgICBlbmNvZGluZyxcbiAgICAgICAgICAgIHZlcnNpb246IFNFUklBTElaQVRJT05WRVJTSU9OLFxuICAgICAgICAgICAgbm90ZXMsXG4gICAgICAgICAgICBmaWVsZHM6IHNlcmlhbGl6ZS5zZXJpYWxpemUoZW5jb2RpbmcpXG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBkZXNlcmlhbGl6ZShpbnB1dDpvYmplY3QsIG91dHB1dDpTZXJpYWxpemFibGUpIHtcbiAgICAgICAgb3V0cHV0LmRlc2VyaWFsaXplKGlucHV0W1wiZmllbGRzXCJdLCBpbnB1dFtcImVuY29kaW5nXCJdKTtcbiAgICB9XG59Il19